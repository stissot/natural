language: node_js
node_js:
  - '10'

cache: yarn

jobs:
  include:
    - stage: test
      script:
        - yarn build-lib
        - yarn build-docs
        - ./node_modules/.bin/ng test natural --progress false --watch=false --browsers ChromeHeadlessCustom
        - ./node_modules/.bin/ng test demo --progress false --watch=false --browsers ChromeHeadlessCustom
        - yarn lint

    - stage: publish docs
      if: branch IN (master, develop)
      script:
        - yarn build-docs
      deploy:
        provider: pages
        skip-cleanup: true
        local-dir: dist/demo
        github-token: $GITHUB_TOKEN
        on:
          all_branches: true

    - stage: publish npm package
      if: tag is present
      script:
        - yarn build-lib
      before_deploy:
        - rm .gitignore
        - cd dist/natural
      deploy:
        provider: npm
        skip-cleanup: true
        email: $NPM_API_EMAIL
        api_key: $NPM_API_KEY
        on:
          tags: true
